-- Phase 10: High-Performance Chunked Migration (Part 1/3)
-- הרץ רק את הבלוק הזה. גם אם יש Timeout בדפדפן, הדאטה-בייס ממשיך לעבוד.
-- המתן דקה לאחר ה-Timeout ובדוק: SELECT count(*) FROM parties;

DO $$
DECLARE
    batch_size INT := 100000;
    processed_count INT;
BEGIN
    INSERT INTO parties (id, tenant_id, type, display_name)
    VALUES ('00000000-0000-0000-0000-000000000000', '00000000-0000-0000-0000-000000000001', 'organization', 'Legacy Data HQ')
    ON CONFLICT (id) DO NOTHING;

    LOOP
        INSERT INTO parties (id, tenant_id, type, display_name, created_at)
        SELECT e.id, e.tenant_id, 'person'::party_type, e.name, e.created_at
        FROM employees e
        LEFT JOIN parties p ON e.id = p.id
        WHERE p.id IS NULL
        LIMIT batch_size
        ON CONFLICT (id) DO NOTHING;
        
        GET DIAGNOSTICS processed_count = ROW_COUNT;
        EXIT WHEN processed_count = 0;
        
        COMMIT; -- מבטיח שהנתונים נשמרים גם אם יש Timeout ב-UI
    END LOOP;
END $$;
